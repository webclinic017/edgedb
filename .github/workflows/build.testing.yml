name: Build Test and Publish a Testing Release

on:
  workflow_dispatch:
    inputs: {}

jobs:
  prep:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4



  build-debian-buster-x86_64:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']
    needs: prep


    steps:
    - name: Build
      uses: docker://ghcr.io/geldata/gelpkg-build-debian-buster:latest
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "buster"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-debian-buster-x86_64
        path: artifacts/debian-buster

  build-debian-buster-aarch64:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']
    needs: prep


    steps:
    - name: Build
      uses: docker://ghcr.io/geldata/gelpkg-build-debian-buster:latest
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "buster"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-debian-buster-aarch64
        path: artifacts/debian-buster

  build-debian-bullseye-x86_64:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']
    needs: prep


    steps:
    - name: Build
      uses: docker://ghcr.io/geldata/gelpkg-build-debian-bullseye:latest
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bullseye"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-debian-bullseye-x86_64
        path: artifacts/debian-bullseye

  build-debian-bullseye-aarch64:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']
    needs: prep


    steps:
    - name: Build
      uses: docker://ghcr.io/geldata/gelpkg-build-debian-bullseye:latest
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bullseye"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-debian-bullseye-aarch64
        path: artifacts/debian-bullseye

  build-debian-bookworm-x86_64:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']
    needs: prep


    steps:
    - name: Build
      uses: docker://ghcr.io/geldata/gelpkg-build-debian-bookworm:latest
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bookworm"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-debian-bookworm-x86_64
        path: artifacts/debian-bookworm

  build-debian-bookworm-aarch64:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']
    needs: prep


    steps:
    - name: Build
      uses: docker://ghcr.io/geldata/gelpkg-build-debian-bookworm:latest
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bookworm"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-debian-bookworm-aarch64
        path: artifacts/debian-bookworm

  build-ubuntu-focal-x86_64:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']
    needs: prep


    steps:
    - name: Build
      uses: docker://ghcr.io/geldata/gelpkg-build-ubuntu-focal:latest
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "focal"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-ubuntu-focal-x86_64
        path: artifacts/ubuntu-focal

  build-ubuntu-focal-aarch64:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']
    needs: prep


    steps:
    - name: Build
      uses: docker://ghcr.io/geldata/gelpkg-build-ubuntu-focal:latest
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "focal"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-ubuntu-focal-aarch64
        path: artifacts/ubuntu-focal

  build-ubuntu-jammy-x86_64:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']
    needs: prep


    steps:
    - name: Build
      uses: docker://ghcr.io/geldata/gelpkg-build-ubuntu-jammy:latest
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "jammy"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-ubuntu-jammy-x86_64
        path: artifacts/ubuntu-jammy

  build-ubuntu-jammy-aarch64:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']
    needs: prep


    steps:
    - name: Build
      uses: docker://ghcr.io/geldata/gelpkg-build-ubuntu-jammy:latest
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "jammy"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-ubuntu-jammy-aarch64
        path: artifacts/ubuntu-jammy

  build-ubuntu-noble-x86_64:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']
    needs: prep


    steps:
    - name: Build
      uses: docker://ghcr.io/geldata/gelpkg-build-ubuntu-noble:latest
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "noble"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-ubuntu-noble-x86_64
        path: artifacts/ubuntu-noble

  build-ubuntu-noble-aarch64:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']
    needs: prep


    steps:
    - name: Build
      uses: docker://ghcr.io/geldata/gelpkg-build-ubuntu-noble:latest
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "noble"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-ubuntu-noble-aarch64
        path: artifacts/ubuntu-noble

  build-centos-8-x86_64:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']
    needs: prep


    steps:
    - name: Build
      uses: docker://ghcr.io/geldata/gelpkg-build-centos-8:latest
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "centos"
        PKG_PLATFORM_VERSION: "8"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-centos-8-x86_64
        path: artifacts/centos-8

  build-centos-8-aarch64:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']
    needs: prep


    steps:
    - name: Build
      uses: docker://ghcr.io/geldata/gelpkg-build-centos-8:latest
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "centos"
        PKG_PLATFORM_VERSION: "8"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-centos-8-aarch64
        path: artifacts/centos-8

  build-rockylinux-9-x86_64:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']
    needs: prep


    steps:
    - name: Build
      uses: docker://ghcr.io/geldata/gelpkg-build-rockylinux-9:latest
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "rockylinux"
        PKG_PLATFORM_VERSION: "9"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-rockylinux-9-x86_64
        path: artifacts/rockylinux-9

  build-rockylinux-9-aarch64:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']
    needs: prep


    steps:
    - name: Build
      uses: docker://ghcr.io/geldata/gelpkg-build-rockylinux-9:latest
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "rockylinux"
        PKG_PLATFORM_VERSION: "9"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-rockylinux-9-aarch64
        path: artifacts/rockylinux-9

  build-linux-x86_64:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']
    needs: prep


    steps:
    - name: Build
      uses: docker://ghcr.io/geldata/gelpkg-build-linux-x86_64:latest
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "x86_64"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"
        BUILD_GENERIC: true
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-linux-x86_64
        path: artifacts/linux-x86_64

  build-linux-aarch64:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']
    needs: prep


    steps:
    - name: Build
      uses: docker://ghcr.io/geldata/gelpkg-build-linux-aarch64:latest
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"
        BUILD_GENERIC: true
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-linux-aarch64
        path: artifacts/linux-aarch64

  build-linuxmusl-x86_64:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']
    needs: prep


    steps:
    - name: Build
      uses: docker://ghcr.io/geldata/gelpkg-build-linuxmusl-x86_64:latest
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "x86_64"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"
        BUILD_GENERIC: true
        PKG_PLATFORM_LIBC: "musl"
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-linuxmusl-x86_64
        path: artifacts/linuxmusl-x86_64

  build-linuxmusl-aarch64:
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']
    needs: prep


    steps:
    - name: Build
      uses: docker://ghcr.io/geldata/gelpkg-build-linuxmusl-aarch64:latest
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        EXTRA_OPTIMIZATIONS: "true"
        BUILD_IS_RELEASE: "true"
        BUILD_GENERIC: true
        PKG_PLATFORM_LIBC: "musl"
        METAPKG_GIT_CACHE: disabled

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-linuxmusl-aarch64
        path: artifacts/linuxmusl-aarch64

  build-macos-x86_64:
    runs-on: ['macos-13']
    needs: prep


    steps:
    - name: Update Homebrew before installing Rust toolchain
      run: |
        # Homebrew renamed `rustup-init` to `rustup`:
        #   https://github.com/Homebrew/homebrew-core/pull/177840
        # But the GitHub Action runner is not updated with this change yet.
        # This caused the later `brew update` in step `Build` to relink Rust
        # toolchain executables, overwriting the custom toolchain installed by
        # `dsherret/rust-toolchain-file`. So let's just run `brew update` early.
        brew update

    - uses: actions/checkout@v4
      if: true
      with:
        sparse-checkout: |
          rust-toolchain.toml
        sparse-checkout-cone-mode: false

    - name: Install Rust toolchain
      uses: dsherret/rust-toolchain-file@v1
      if: true

    - uses: actions/checkout@v4
      with:
        repository: edgedb/edgedb-pkg
        ref: master
        path: edgedb-pkg

    - name: Set up Python
      uses: actions/setup-python@v5
      if: true
      with:
        python-version: "3.12"

    - name: Set up NodeJS
      uses: actions/setup-node@v4
      if: true
      with:
        node-version: '20'

    - name: Install dependencies
      if: true
      run: |
        env HOMEBREW_NO_AUTO_UPDATE=1 brew install libmagic

    - name: Install an alias
      # This is probably not strictly needed, but sentencepiece build script reports
      # errors without it.
      if: true
      run: |
        printf '#!/bin/sh\n\nexec sysctl -n hw.logicalcpu' > /usr/local/bin/nproc
        chmod +x /usr/local/bin/nproc

    - name: Build
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        BUILD_IS_RELEASE: "true"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "macos"
        PKG_PLATFORM_VERSION: "x86_64"
        PKG_PLATFORM_ARCH: "x86_64"
        EXTRA_OPTIMIZATIONS: "true"
        METAPKG_GIT_CACHE: disabled
        BUILD_GENERIC: true
        CMAKE_POLICY_VERSION_MINIMUM: '3.5'
      run: |
        edgedb-pkg/integration/macos/build.sh

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-macos-x86_64
        path: artifacts/macos-x86_64

  build-macos-aarch64:
    runs-on: ['macos-14']
    needs: prep


    steps:
    - name: Update Homebrew before installing Rust toolchain
      run: |
        # Homebrew renamed `rustup-init` to `rustup`:
        #   https://github.com/Homebrew/homebrew-core/pull/177840
        # But the GitHub Action runner is not updated with this change yet.
        # This caused the later `brew update` in step `Build` to relink Rust
        # toolchain executables, overwriting the custom toolchain installed by
        # `dsherret/rust-toolchain-file`. So let's just run `brew update` early.
        brew update

    - uses: actions/checkout@v4
      if: true
      with:
        sparse-checkout: |
          rust-toolchain.toml
        sparse-checkout-cone-mode: false

    - name: Install Rust toolchain
      uses: dsherret/rust-toolchain-file@v1
      if: true

    - uses: actions/checkout@v4
      with:
        repository: edgedb/edgedb-pkg
        ref: master
        path: edgedb-pkg

    - name: Set up Python
      uses: actions/setup-python@v5
      if: true
      with:
        python-version: "3.12"

    - name: Set up NodeJS
      uses: actions/setup-node@v4
      if: true
      with:
        node-version: '20'

    - name: Install dependencies
      if: true
      run: |
        env HOMEBREW_NO_AUTO_UPDATE=1 brew install libmagic

    - name: Install an alias
      # This is probably not strictly needed, but sentencepiece build script reports
      # errors without it.
      if: true
      run: |
        printf '#!/bin/sh\n\nexec sysctl -n hw.logicalcpu' > /usr/local/bin/nproc
        chmod +x /usr/local/bin/nproc

    - name: Build
      env:
        PACKAGE: "edgedbpkg.edgedb:Gel"
        SRC_REF: "${{ github.sha }}"
        BUILD_IS_RELEASE: "true"
        PKG_REVISION: "<current-date>"
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "macos"
        PKG_PLATFORM_VERSION: "aarch64"
        PKG_PLATFORM_ARCH: "aarch64"
        EXTRA_OPTIMIZATIONS: "true"
        METAPKG_GIT_CACHE: disabled
        BUILD_GENERIC: true
        CMAKE_POLICY_VERSION_MINIMUM: '3.5'
      run: |
        edgedb-pkg/integration/macos/build.sh

    - uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874  # v4.4.0
      with:
        name: builds-macos-aarch64
        path: artifacts/macos-aarch64

  test-debian-buster-x86_64:
    needs: [build-debian-buster-x86_64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-debian-buster-x86_64
        path: artifacts/debian-buster

    - name: Test
      uses: docker://ghcr.io/geldata/gelpkg-test-debian-buster:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "buster"
        PKG_PLATFORM_LIBC: ""
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-debian-buster-aarch64:
    needs: [build-debian-buster-aarch64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-debian-buster-aarch64
        path: artifacts/debian-buster

    - name: Test
      uses: docker://ghcr.io/geldata/gelpkg-test-debian-buster:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "buster"
        PKG_PLATFORM_LIBC: ""
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-debian-bullseye-x86_64:
    needs: [build-debian-bullseye-x86_64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-debian-bullseye-x86_64
        path: artifacts/debian-bullseye

    - name: Test
      uses: docker://ghcr.io/geldata/gelpkg-test-debian-bullseye:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bullseye"
        PKG_PLATFORM_LIBC: ""
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-debian-bullseye-aarch64:
    needs: [build-debian-bullseye-aarch64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-debian-bullseye-aarch64
        path: artifacts/debian-bullseye

    - name: Test
      uses: docker://ghcr.io/geldata/gelpkg-test-debian-bullseye:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bullseye"
        PKG_PLATFORM_LIBC: ""
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-debian-bookworm-x86_64:
    needs: [build-debian-bookworm-x86_64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-debian-bookworm-x86_64
        path: artifacts/debian-bookworm

    - name: Test
      uses: docker://ghcr.io/geldata/gelpkg-test-debian-bookworm:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bookworm"
        PKG_PLATFORM_LIBC: ""
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-debian-bookworm-aarch64:
    needs: [build-debian-bookworm-aarch64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-debian-bookworm-aarch64
        path: artifacts/debian-bookworm

    - name: Test
      uses: docker://ghcr.io/geldata/gelpkg-test-debian-bookworm:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bookworm"
        PKG_PLATFORM_LIBC: ""
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-ubuntu-focal-x86_64:
    needs: [build-ubuntu-focal-x86_64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-ubuntu-focal-x86_64
        path: artifacts/ubuntu-focal

    - name: Test
      uses: docker://ghcr.io/geldata/gelpkg-test-ubuntu-focal:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "focal"
        PKG_PLATFORM_LIBC: ""
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-ubuntu-focal-aarch64:
    needs: [build-ubuntu-focal-aarch64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-ubuntu-focal-aarch64
        path: artifacts/ubuntu-focal

    - name: Test
      uses: docker://ghcr.io/geldata/gelpkg-test-ubuntu-focal:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "focal"
        PKG_PLATFORM_LIBC: ""
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-ubuntu-jammy-x86_64:
    needs: [build-ubuntu-jammy-x86_64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-ubuntu-jammy-x86_64
        path: artifacts/ubuntu-jammy

    - name: Test
      uses: docker://ghcr.io/geldata/gelpkg-test-ubuntu-jammy:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "jammy"
        PKG_PLATFORM_LIBC: ""
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-ubuntu-jammy-aarch64:
    needs: [build-ubuntu-jammy-aarch64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-ubuntu-jammy-aarch64
        path: artifacts/ubuntu-jammy

    - name: Test
      uses: docker://ghcr.io/geldata/gelpkg-test-ubuntu-jammy:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "jammy"
        PKG_PLATFORM_LIBC: ""
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-ubuntu-noble-x86_64:
    needs: [build-ubuntu-noble-x86_64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-ubuntu-noble-x86_64
        path: artifacts/ubuntu-noble

    - name: Test
      uses: docker://ghcr.io/geldata/gelpkg-test-ubuntu-noble:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "noble"
        PKG_PLATFORM_LIBC: ""
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-ubuntu-noble-aarch64:
    needs: [build-ubuntu-noble-aarch64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-ubuntu-noble-aarch64
        path: artifacts/ubuntu-noble

    - name: Test
      uses: docker://ghcr.io/geldata/gelpkg-test-ubuntu-noble:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "noble"
        PKG_PLATFORM_LIBC: ""
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-centos-8-x86_64:
    needs: [build-centos-8-x86_64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-centos-8-x86_64
        path: artifacts/centos-8

    - name: Test
      uses: docker://ghcr.io/geldata/gelpkg-test-centos-8:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "centos"
        PKG_PLATFORM_VERSION: "8"
        PKG_PLATFORM_LIBC: ""
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-centos-8-aarch64:
    needs: [build-centos-8-aarch64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-centos-8-aarch64
        path: artifacts/centos-8

    - name: Test
      uses: docker://ghcr.io/geldata/gelpkg-test-centos-8:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "centos"
        PKG_PLATFORM_VERSION: "8"
        PKG_PLATFORM_LIBC: ""
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-rockylinux-9-x86_64:
    needs: [build-rockylinux-9-x86_64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-rockylinux-9-x86_64
        path: artifacts/rockylinux-9

    - name: Test
      uses: docker://ghcr.io/geldata/gelpkg-test-rockylinux-9:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "rockylinux"
        PKG_PLATFORM_VERSION: "9"
        PKG_PLATFORM_LIBC: ""
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-rockylinux-9-aarch64:
    needs: [build-rockylinux-9-aarch64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-rockylinux-9-aarch64
        path: artifacts/rockylinux-9

    - name: Test
      uses: docker://ghcr.io/geldata/gelpkg-test-rockylinux-9:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "rockylinux"
        PKG_PLATFORM_VERSION: "9"
        PKG_PLATFORM_LIBC: ""
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-linux-x86_64:
    needs: [build-linux-x86_64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linux-x86_64
        path: artifacts/linux-x86_64

    - name: Test
      uses: docker://ghcr.io/geldata/gelpkg-test-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "x86_64"
        PKG_PLATFORM_LIBC: ""
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-linux-aarch64:
    needs: [build-linux-aarch64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linux-aarch64
        path: artifacts/linux-aarch64

    - name: Test
      uses: docker://ghcr.io/geldata/gelpkg-test-linux-aarch64:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        PKG_PLATFORM_LIBC: ""
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-linuxmusl-x86_64:
    needs: [build-linuxmusl-x86_64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linuxmusl-x86_64
        path: artifacts/linuxmusl-x86_64

    - name: Test
      uses: docker://ghcr.io/geldata/gelpkg-test-linuxmusl-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "x86_64"
        PKG_PLATFORM_LIBC: "musl"
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-linuxmusl-aarch64:
    needs: [build-linuxmusl-aarch64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linuxmusl-aarch64
        path: artifacts/linuxmusl-aarch64

    - name: Test
      uses: docker://ghcr.io/geldata/gelpkg-test-linuxmusl-aarch64:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        PKG_PLATFORM_LIBC: "musl"
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
        # edb test with -j higher than 1 seems to result in workflow
        # jobs getting killed arbitrarily by Github.
        PKG_TEST_JOBS: 0

  test-macos-x86_64:
    needs: [build-macos-x86_64]
    runs-on: ['macos-13']

    steps:
    - uses: actions/checkout@v4
      with:
        repository: edgedb/edgedb-pkg
        ref: master
        path: edgedb-pkg

    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-macos-x86_64
        path: artifacts/macos-x86_64

    - name: Test
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "macos"
        PKG_PLATFORM_VERSION: "x86_64"
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " test_dump*.py test_backend_*.py test_database.py test_server_*.py test_edgeql_ddl.py test_session.py
"
      run: |
        # Bump shmmax and shmall to avoid test failures.
        sudo sysctl -w kern.sysv.shmmax=12582912
        sudo sysctl -w kern.sysv.shmall=12582912
        edgedb-pkg/integration/macos/test.sh

  test-macos-aarch64:
    needs: [build-macos-aarch64]
    runs-on: ['macos-14']

    steps:
    - uses: actions/checkout@v4
      with:
        repository: edgedb/edgedb-pkg
        ref: master
        path: edgedb-pkg

    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-macos-aarch64
        path: artifacts/macos-aarch64

    - name: Test
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "macos"
        PKG_PLATFORM_VERSION: "aarch64"
        PKG_TEST_SELECT: ""
        PKG_TEST_EXCLUDE: ""
        PKG_TEST_FILES: " "
      run: |
        edgedb-pkg/integration/macos/test.sh
  collect:
    needs:
    - test-debian-buster-x86_64
    - test-debian-buster-aarch64
    - test-debian-bullseye-x86_64
    - test-debian-bullseye-aarch64
    - test-debian-bookworm-x86_64
    - test-debian-bookworm-aarch64
    - test-ubuntu-focal-x86_64
    - test-ubuntu-focal-aarch64
    - test-ubuntu-jammy-x86_64
    - test-ubuntu-jammy-aarch64
    - test-ubuntu-noble-x86_64
    - test-ubuntu-noble-aarch64
    - test-centos-8-x86_64
    - test-centos-8-aarch64
    - test-rockylinux-9-x86_64
    - test-rockylinux-9-aarch64
    - test-linux-x86_64
    - test-linux-aarch64
    - test-linuxmusl-x86_64
    - test-linuxmusl-aarch64
    - test-macos-x86_64
    - test-macos-aarch64
    runs-on: ubuntu-latest
    steps:
      - run: echo 'All build+tests passed, ready to publish now!'

  publish-debian-buster-x86_64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-debian-buster-x86_64
        path: artifacts/debian-buster

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "buster"
        PKG_PLATFORM_LIBC: ""
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-debian-buster-x86_64:
    needs: [publish-debian-buster-x86_64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-debian-buster-x86_64
        path: artifacts/debian-buster

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: debian-buster

    - name: Test Published
      uses: docker://ghcr.io/geldata/gelpkg-testpublished-debian-buster:latest
      env:
        PKG_NAME: "${{ steps.describe.outputs.name }}"
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "buster"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    outputs:
      version-slot: ${{ steps.describe.outputs.version-slot }}
      version-core: ${{ steps.describe.outputs.version-core }}
      catalog-version: ${{ steps.describe.outputs.catalog-version }}

  publish-debian-buster-aarch64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-debian-buster-aarch64
        path: artifacts/debian-buster

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "buster"
        PKG_PLATFORM_LIBC: ""
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-debian-buster-aarch64:
    needs: [publish-debian-buster-aarch64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-debian-buster-aarch64
        path: artifacts/debian-buster

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: debian-buster

    - name: Test Published
      uses: docker://ghcr.io/geldata/gelpkg-testpublished-debian-buster:latest
      env:
        PKG_NAME: "${{ steps.describe.outputs.name }}"
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "buster"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    outputs:
      version-slot: ${{ steps.describe.outputs.version-slot }}
      version-core: ${{ steps.describe.outputs.version-core }}
      catalog-version: ${{ steps.describe.outputs.catalog-version }}

  publish-debian-bullseye-x86_64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-debian-bullseye-x86_64
        path: artifacts/debian-bullseye

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bullseye"
        PKG_PLATFORM_LIBC: ""
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-debian-bullseye-x86_64:
    needs: [publish-debian-bullseye-x86_64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-debian-bullseye-x86_64
        path: artifacts/debian-bullseye

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: debian-bullseye

    - name: Test Published
      uses: docker://ghcr.io/geldata/gelpkg-testpublished-debian-bullseye:latest
      env:
        PKG_NAME: "${{ steps.describe.outputs.name }}"
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bullseye"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    outputs:
      version-slot: ${{ steps.describe.outputs.version-slot }}
      version-core: ${{ steps.describe.outputs.version-core }}
      catalog-version: ${{ steps.describe.outputs.catalog-version }}

  publish-debian-bullseye-aarch64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-debian-bullseye-aarch64
        path: artifacts/debian-bullseye

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bullseye"
        PKG_PLATFORM_LIBC: ""
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-debian-bullseye-aarch64:
    needs: [publish-debian-bullseye-aarch64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-debian-bullseye-aarch64
        path: artifacts/debian-bullseye

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: debian-bullseye

    - name: Test Published
      uses: docker://ghcr.io/geldata/gelpkg-testpublished-debian-bullseye:latest
      env:
        PKG_NAME: "${{ steps.describe.outputs.name }}"
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bullseye"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    outputs:
      version-slot: ${{ steps.describe.outputs.version-slot }}
      version-core: ${{ steps.describe.outputs.version-core }}
      catalog-version: ${{ steps.describe.outputs.catalog-version }}

  publish-debian-bookworm-x86_64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-debian-bookworm-x86_64
        path: artifacts/debian-bookworm

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bookworm"
        PKG_PLATFORM_LIBC: ""
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-debian-bookworm-x86_64:
    needs: [publish-debian-bookworm-x86_64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-debian-bookworm-x86_64
        path: artifacts/debian-bookworm

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: debian-bookworm

    - name: Test Published
      uses: docker://ghcr.io/geldata/gelpkg-testpublished-debian-bookworm:latest
      env:
        PKG_NAME: "${{ steps.describe.outputs.name }}"
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bookworm"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    outputs:
      version-slot: ${{ steps.describe.outputs.version-slot }}
      version-core: ${{ steps.describe.outputs.version-core }}
      catalog-version: ${{ steps.describe.outputs.catalog-version }}

  publish-debian-bookworm-aarch64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-debian-bookworm-aarch64
        path: artifacts/debian-bookworm

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bookworm"
        PKG_PLATFORM_LIBC: ""
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-debian-bookworm-aarch64:
    needs: [publish-debian-bookworm-aarch64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-debian-bookworm-aarch64
        path: artifacts/debian-bookworm

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: debian-bookworm

    - name: Test Published
      uses: docker://ghcr.io/geldata/gelpkg-testpublished-debian-bookworm:latest
      env:
        PKG_NAME: "${{ steps.describe.outputs.name }}"
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "debian"
        PKG_PLATFORM_VERSION: "bookworm"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    outputs:
      version-slot: ${{ steps.describe.outputs.version-slot }}
      version-core: ${{ steps.describe.outputs.version-core }}
      catalog-version: ${{ steps.describe.outputs.catalog-version }}

  publish-ubuntu-focal-x86_64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-ubuntu-focal-x86_64
        path: artifacts/ubuntu-focal

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "focal"
        PKG_PLATFORM_LIBC: ""
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-ubuntu-focal-x86_64:
    needs: [publish-ubuntu-focal-x86_64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-ubuntu-focal-x86_64
        path: artifacts/ubuntu-focal

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: ubuntu-focal

    - name: Test Published
      uses: docker://ghcr.io/geldata/gelpkg-testpublished-ubuntu-focal:latest
      env:
        PKG_NAME: "${{ steps.describe.outputs.name }}"
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "focal"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    outputs:
      version-slot: ${{ steps.describe.outputs.version-slot }}
      version-core: ${{ steps.describe.outputs.version-core }}
      catalog-version: ${{ steps.describe.outputs.catalog-version }}

  publish-ubuntu-focal-aarch64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-ubuntu-focal-aarch64
        path: artifacts/ubuntu-focal

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "focal"
        PKG_PLATFORM_LIBC: ""
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-ubuntu-focal-aarch64:
    needs: [publish-ubuntu-focal-aarch64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-ubuntu-focal-aarch64
        path: artifacts/ubuntu-focal

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: ubuntu-focal

    - name: Test Published
      uses: docker://ghcr.io/geldata/gelpkg-testpublished-ubuntu-focal:latest
      env:
        PKG_NAME: "${{ steps.describe.outputs.name }}"
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "focal"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    outputs:
      version-slot: ${{ steps.describe.outputs.version-slot }}
      version-core: ${{ steps.describe.outputs.version-core }}
      catalog-version: ${{ steps.describe.outputs.catalog-version }}

  publish-ubuntu-jammy-x86_64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-ubuntu-jammy-x86_64
        path: artifacts/ubuntu-jammy

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "jammy"
        PKG_PLATFORM_LIBC: ""
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-ubuntu-jammy-x86_64:
    needs: [publish-ubuntu-jammy-x86_64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-ubuntu-jammy-x86_64
        path: artifacts/ubuntu-jammy

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: ubuntu-jammy

    - name: Test Published
      uses: docker://ghcr.io/geldata/gelpkg-testpublished-ubuntu-jammy:latest
      env:
        PKG_NAME: "${{ steps.describe.outputs.name }}"
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "jammy"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    outputs:
      version-slot: ${{ steps.describe.outputs.version-slot }}
      version-core: ${{ steps.describe.outputs.version-core }}
      catalog-version: ${{ steps.describe.outputs.catalog-version }}

  publish-ubuntu-jammy-aarch64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-ubuntu-jammy-aarch64
        path: artifacts/ubuntu-jammy

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "jammy"
        PKG_PLATFORM_LIBC: ""
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-ubuntu-jammy-aarch64:
    needs: [publish-ubuntu-jammy-aarch64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-ubuntu-jammy-aarch64
        path: artifacts/ubuntu-jammy

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: ubuntu-jammy

    - name: Test Published
      uses: docker://ghcr.io/geldata/gelpkg-testpublished-ubuntu-jammy:latest
      env:
        PKG_NAME: "${{ steps.describe.outputs.name }}"
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "jammy"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    outputs:
      version-slot: ${{ steps.describe.outputs.version-slot }}
      version-core: ${{ steps.describe.outputs.version-core }}
      catalog-version: ${{ steps.describe.outputs.catalog-version }}

  publish-ubuntu-noble-x86_64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-ubuntu-noble-x86_64
        path: artifacts/ubuntu-noble

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "noble"
        PKG_PLATFORM_LIBC: ""
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-ubuntu-noble-x86_64:
    needs: [publish-ubuntu-noble-x86_64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-ubuntu-noble-x86_64
        path: artifacts/ubuntu-noble

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: ubuntu-noble

    - name: Test Published
      uses: docker://ghcr.io/geldata/gelpkg-testpublished-ubuntu-noble:latest
      env:
        PKG_NAME: "${{ steps.describe.outputs.name }}"
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "noble"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    outputs:
      version-slot: ${{ steps.describe.outputs.version-slot }}
      version-core: ${{ steps.describe.outputs.version-core }}
      catalog-version: ${{ steps.describe.outputs.catalog-version }}

  publish-ubuntu-noble-aarch64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-ubuntu-noble-aarch64
        path: artifacts/ubuntu-noble

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "noble"
        PKG_PLATFORM_LIBC: ""
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-ubuntu-noble-aarch64:
    needs: [publish-ubuntu-noble-aarch64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-ubuntu-noble-aarch64
        path: artifacts/ubuntu-noble

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: ubuntu-noble

    - name: Test Published
      uses: docker://ghcr.io/geldata/gelpkg-testpublished-ubuntu-noble:latest
      env:
        PKG_NAME: "${{ steps.describe.outputs.name }}"
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "ubuntu"
        PKG_PLATFORM_VERSION: "noble"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    outputs:
      version-slot: ${{ steps.describe.outputs.version-slot }}
      version-core: ${{ steps.describe.outputs.version-core }}
      catalog-version: ${{ steps.describe.outputs.catalog-version }}

  publish-centos-8-x86_64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-centos-8-x86_64
        path: artifacts/centos-8

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "centos"
        PKG_PLATFORM_VERSION: "8"
        PKG_PLATFORM_LIBC: ""
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-centos-8-x86_64:
    needs: [publish-centos-8-x86_64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-centos-8-x86_64
        path: artifacts/centos-8

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: centos-8

    - name: Test Published
      uses: docker://ghcr.io/geldata/gelpkg-testpublished-centos-8:latest
      env:
        PKG_NAME: "${{ steps.describe.outputs.name }}"
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "centos"
        PKG_PLATFORM_VERSION: "8"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    outputs:
      version-slot: ${{ steps.describe.outputs.version-slot }}
      version-core: ${{ steps.describe.outputs.version-core }}
      catalog-version: ${{ steps.describe.outputs.catalog-version }}

  publish-centos-8-aarch64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-centos-8-aarch64
        path: artifacts/centos-8

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "centos"
        PKG_PLATFORM_VERSION: "8"
        PKG_PLATFORM_LIBC: ""
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-centos-8-aarch64:
    needs: [publish-centos-8-aarch64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-centos-8-aarch64
        path: artifacts/centos-8

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: centos-8

    - name: Test Published
      uses: docker://ghcr.io/geldata/gelpkg-testpublished-centos-8:latest
      env:
        PKG_NAME: "${{ steps.describe.outputs.name }}"
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "centos"
        PKG_PLATFORM_VERSION: "8"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    outputs:
      version-slot: ${{ steps.describe.outputs.version-slot }}
      version-core: ${{ steps.describe.outputs.version-core }}
      catalog-version: ${{ steps.describe.outputs.catalog-version }}

  publish-rockylinux-9-x86_64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-rockylinux-9-x86_64
        path: artifacts/rockylinux-9

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "rockylinux"
        PKG_PLATFORM_VERSION: "9"
        PKG_PLATFORM_LIBC: ""
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-rockylinux-9-x86_64:
    needs: [publish-rockylinux-9-x86_64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-rockylinux-9-x86_64
        path: artifacts/rockylinux-9

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: rockylinux-9

    - name: Test Published
      uses: docker://ghcr.io/geldata/gelpkg-testpublished-rockylinux-9:latest
      env:
        PKG_NAME: "${{ steps.describe.outputs.name }}"
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "rockylinux"
        PKG_PLATFORM_VERSION: "9"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    outputs:
      version-slot: ${{ steps.describe.outputs.version-slot }}
      version-core: ${{ steps.describe.outputs.version-core }}
      catalog-version: ${{ steps.describe.outputs.catalog-version }}

  publish-rockylinux-9-aarch64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-rockylinux-9-aarch64
        path: artifacts/rockylinux-9

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "rockylinux"
        PKG_PLATFORM_VERSION: "9"
        PKG_PLATFORM_LIBC: ""
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-rockylinux-9-aarch64:
    needs: [publish-rockylinux-9-aarch64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-rockylinux-9-aarch64
        path: artifacts/rockylinux-9

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: rockylinux-9

    - name: Test Published
      uses: docker://ghcr.io/geldata/gelpkg-testpublished-rockylinux-9:latest
      env:
        PKG_NAME: "${{ steps.describe.outputs.name }}"
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "rockylinux"
        PKG_PLATFORM_VERSION: "9"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    outputs:
      version-slot: ${{ steps.describe.outputs.version-slot }}
      version-core: ${{ steps.describe.outputs.version-core }}
      catalog-version: ${{ steps.describe.outputs.catalog-version }}

  publish-linux-x86_64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linux-x86_64
        path: artifacts/linux-x86_64

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "x86_64"
        PKG_PLATFORM_LIBC: ""
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-linux-x86_64:
    needs: [publish-linux-x86_64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linux-x86_64
        path: artifacts/linux-x86_64

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: linux-x86_64

    - name: Test Published
      uses: docker://ghcr.io/geldata/gelpkg-testpublished-linux-x86_64:latest
      env:
        PKG_NAME: "${{ steps.describe.outputs.name }}"
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "x86_64"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    outputs:
      version-slot: ${{ steps.describe.outputs.version-slot }}
      version-core: ${{ steps.describe.outputs.version-core }}
      catalog-version: ${{ steps.describe.outputs.catalog-version }}

  publish-linux-aarch64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linux-aarch64
        path: artifacts/linux-aarch64

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        PKG_PLATFORM_LIBC: ""
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-linux-aarch64:
    needs: [publish-linux-aarch64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linux-aarch64
        path: artifacts/linux-aarch64

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: linux-aarch64

    - name: Test Published
      uses: docker://ghcr.io/geldata/gelpkg-testpublished-linux-aarch64:latest
      env:
        PKG_NAME: "${{ steps.describe.outputs.name }}"
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    outputs:
      version-slot: ${{ steps.describe.outputs.version-slot }}
      version-core: ${{ steps.describe.outputs.version-core }}
      catalog-version: ${{ steps.describe.outputs.catalog-version }}

  publish-linuxmusl-x86_64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linuxmusl-x86_64
        path: artifacts/linuxmusl-x86_64

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "x86_64"
        PKG_PLATFORM_LIBC: "musl"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-linuxmusl-x86_64:
    needs: [publish-linuxmusl-x86_64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'x64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linuxmusl-x86_64
        path: artifacts/linuxmusl-x86_64

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: linuxmusl-x86_64

    - name: Test Published
      uses: docker://ghcr.io/geldata/gelpkg-testpublished-linuxmusl-x86_64:latest
      env:
        PKG_NAME: "${{ steps.describe.outputs.name }}"
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "x86_64"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    outputs:
      version-slot: ${{ steps.describe.outputs.version-slot }}
      version-core: ${{ steps.describe.outputs.version-core }}
      catalog-version: ${{ steps.describe.outputs.catalog-version }}

  publish-linuxmusl-aarch64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linuxmusl-aarch64
        path: artifacts/linuxmusl-aarch64

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        PKG_PLATFORM_LIBC: "musl"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  check-published-linuxmusl-aarch64:
    needs: [publish-linuxmusl-aarch64]
    runs-on: ['package-builder', 'self-hosted', 'linux', 'arm64']

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-linuxmusl-aarch64
        path: artifacts/linuxmusl-aarch64

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: linuxmusl-aarch64

    - name: Test Published
      uses: docker://ghcr.io/geldata/gelpkg-testpublished-linuxmusl-aarch64:latest
      env:
        PKG_NAME: "${{ steps.describe.outputs.name }}"
        PKG_SUBDIST: "testing"
        PACKAGE_SERVER: sftp://uploader@package-upload.edgedb.net:22/
        PKG_PLATFORM: "linux"
        PKG_PLATFORM_VERSION: "aarch64"
        PKG_INSTALL_REF: "${{ steps.describe.outputs.install-ref }}"
        PKG_VERSION_SLOT: "${{ steps.describe.outputs.version-slot }}"

    outputs:
      version-slot: ${{ steps.describe.outputs.version-slot }}
      version-core: ${{ steps.describe.outputs.version-core }}
      catalog-version: ${{ steps.describe.outputs.catalog-version }}

  publish-macos-x86_64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-macos-x86_64
        path: artifacts/macos-x86_64

    - uses: actions/checkout@v4
      with:
        repository: edgedb/edgedb-pkg
        ref: master
        path: edgedb-pkg

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: macos-x86_64

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "macos"
        PKG_PLATFORM_VERSION: "x86_64"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  publish-macos-aarch64:
    needs: [collect]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16  # v4.1.8
      with:
        name: builds-macos-aarch64
        path: artifacts/macos-aarch64

    - uses: actions/checkout@v4
      with:
        repository: edgedb/edgedb-pkg
        ref: master
        path: edgedb-pkg

    - name: Describe
      id: describe
      uses: edgedb/edgedb-pkg/integration/actions/describe-artifact@master
      with:
        target: macos-aarch64

    - name: Publish
      uses: docker://ghcr.io/geldata/gelpkg-upload-linux-x86_64:latest
      env:
        PKG_SUBDIST: "testing"
        PKG_PLATFORM: "macos"
        PKG_PLATFORM_VERSION: "aarch64"
        PACKAGE_UPLOAD_SSH_KEY: "${{ secrets.PACKAGE_UPLOAD_SSH_KEY }}"

  publish-docker:
    needs:
      - check-published-debian-bookworm-x86_64
      - check-published-debian-bookworm-aarch64
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        repository: geldata/gel-docker
        ref: master
        path: dockerfile

    - name: Login to Docker Hub
      uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Login to GitHub Container Registry
      uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
      with:
        registry: ghcr.io
        username: "edgedb-ci"
        password: ${{ secrets.GITHUB_CI_BOT_TOKEN }}

    - env:
        VERSION_SLOT: "${{ needs.check-published-debian-bookworm-x86_64.outputs.version-slot }}"
        VERSION_CORE: "${{ needs.check-published-debian-bookworm-x86_64.outputs.version-core }}"
        CATALOG_VERSION: "${{ needs.check-published-debian-bookworm-x86_64.outputs.catalog-version }}"
        PKG_SUBDIST: "testing"
      id: tags
      run: |
        set -e

        url='https://registry.hub.docker.com/v2/repositories/geldata/gel/tags?page_size=100'
        repo_tags=$(
          while [ -n "$url" ]; do
            resp=$(curl -L -s "$url")
            url=$(echo "$resp" | jq -r ".next")
            if [ "$url" = "null" ] || [ -z "$url" ]; then
              break
            fi
            echo "$resp" | jq -r '."results"[]["name"]'
          done | grep "^[[:digit:]]\+.*" | grep -v "alpha\|beta\|rc" || :
        )

        tags=()

        if [ "$PKG_SUBDIST" = "nightly" ]; then
          tags+=(
            "nightly"
            "nightly_${VERSION_SLOT}_cv${CATALOG_VERSION}"
          )
        else
          tags+=( "$VERSION_CORE" )

          top=$(printf "%s\n%s\n" "$VERSION_CORE" "$repo_tags" \
                | grep "^${VERSION_SLOT}[\.-]" \
                | sort --version-sort --reverse | head -n 1)
          if [ "$top" == "$VERSION_CORE" ]; then
            tags+=( "$VERSION_SLOT" )
          fi

          if [ -z "$PKG_SUBDIST" ]; then
            top=$(printf "%s\n%s\n" "$VERSION_CORE" "$repo_tags" \
                  | sort --version-sort --reverse | head -n 1)
            if [ "$top" == "$VERSION_CORE" ]; then
              tags+=( "latest" )
            fi
          fi
        fi

        fq_tags=()
        images=("geldata/gel" "ghcr.io/geldata/gel")

        for image in "${images[@]}"; do
          fq_tags+=("${tags[@]/#/${image}:}")
        done

        IFS=,
        echo "tags=${fq_tags[*]}" >> $GITHUB_OUTPUT

    - name: Set up QEMU
      uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3.6.0

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@b5ca514318bd6ebac0fb2aedd5d36ec1b5c232a2 # v3.10.0

    - name: Build and Publish Docker Image
      uses: docker/build-push-action@471d1dc4e07e5cdedd4c2171150001c434f0b7a4 # v6.10.0
      with:
        push: true
        provenance: mode=max
        tags: "${{ steps.tags.outputs.tags }}"
        context: dockerfile
        build-args: |
          version=${{ needs.check-published-debian-bookworm-x86_64.outputs.version-slot }}
          exact_version=${{ needs.check-published-debian-bookworm-x86_64.outputs.version-core }}
          subdist=testing
        platforms: linux/amd64,linux/arm64

  workflow-notifications:
    if: failure() && github.event_name != 'pull_request'
    name: Notify in Slack on failures

    needs:
      - prep
      - collect
      - build-debian-buster-x86_64
      - test-debian-buster-x86_64
      - publish-debian-buster-x86_64
      - check-published-debian-buster-x86_64
      - build-debian-buster-aarch64
      - test-debian-buster-aarch64
      - publish-debian-buster-aarch64
      - check-published-debian-buster-aarch64
      - build-debian-bullseye-x86_64
      - test-debian-bullseye-x86_64
      - publish-debian-bullseye-x86_64
      - check-published-debian-bullseye-x86_64
      - build-debian-bullseye-aarch64
      - test-debian-bullseye-aarch64
      - publish-debian-bullseye-aarch64
      - check-published-debian-bullseye-aarch64
      - build-debian-bookworm-x86_64
      - test-debian-bookworm-x86_64
      - publish-debian-bookworm-x86_64
      - check-published-debian-bookworm-x86_64
      - build-debian-bookworm-aarch64
      - test-debian-bookworm-aarch64
      - publish-debian-bookworm-aarch64
      - check-published-debian-bookworm-aarch64
      - build-ubuntu-focal-x86_64
      - test-ubuntu-focal-x86_64
      - publish-ubuntu-focal-x86_64
      - check-published-ubuntu-focal-x86_64
      - build-ubuntu-focal-aarch64
      - test-ubuntu-focal-aarch64
      - publish-ubuntu-focal-aarch64
      - check-published-ubuntu-focal-aarch64
      - build-ubuntu-jammy-x86_64
      - test-ubuntu-jammy-x86_64
      - publish-ubuntu-jammy-x86_64
      - check-published-ubuntu-jammy-x86_64
      - build-ubuntu-jammy-aarch64
      - test-ubuntu-jammy-aarch64
      - publish-ubuntu-jammy-aarch64
      - check-published-ubuntu-jammy-aarch64
      - build-ubuntu-noble-x86_64
      - test-ubuntu-noble-x86_64
      - publish-ubuntu-noble-x86_64
      - check-published-ubuntu-noble-x86_64
      - build-ubuntu-noble-aarch64
      - test-ubuntu-noble-aarch64
      - publish-ubuntu-noble-aarch64
      - check-published-ubuntu-noble-aarch64
      - build-centos-8-x86_64
      - test-centos-8-x86_64
      - publish-centos-8-x86_64
      - check-published-centos-8-x86_64
      - build-centos-8-aarch64
      - test-centos-8-aarch64
      - publish-centos-8-aarch64
      - check-published-centos-8-aarch64
      - build-rockylinux-9-x86_64
      - test-rockylinux-9-x86_64
      - publish-rockylinux-9-x86_64
      - check-published-rockylinux-9-x86_64
      - build-rockylinux-9-aarch64
      - test-rockylinux-9-aarch64
      - publish-rockylinux-9-aarch64
      - check-published-rockylinux-9-aarch64
      - build-linux-x86_64
      - test-linux-x86_64
      - publish-linux-x86_64
      - check-published-linux-x86_64
      - build-linux-aarch64
      - test-linux-aarch64
      - publish-linux-aarch64
      - check-published-linux-aarch64
      - build-linuxmusl-x86_64
      - test-linuxmusl-x86_64
      - publish-linuxmusl-x86_64
      - check-published-linuxmusl-x86_64
      - build-linuxmusl-aarch64
      - test-linuxmusl-aarch64
      - publish-linuxmusl-aarch64
      - check-published-linuxmusl-aarch64
      - build-macos-x86_64
      - test-macos-x86_64
      - publish-macos-x86_64
      - build-macos-aarch64
      - test-macos-aarch64
      - publish-macos-aarch64
      - publish-docker
    runs-on: ubuntu-latest
    permissions:
      actions: 'read'
    steps:
      - name: Slack Workflow Notification
        uses: Gamesight/slack-workflow-status@26a36836c887f260477432e4314ec3490a84f309
        with:
          repo_token: ${{secrets.GITHUB_TOKEN}}
          slack_webhook_url: ${{secrets.ACTIONS_SLACK_WEBHOOK_URL}}
          name: 'Workflow notifications'
          icon_emoji: ':hammer:'
          include_jobs: 'on-failure'
